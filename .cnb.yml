# ============================================
# CNB äº‘åŸç”Ÿæ„å»ºé…ç½®
# ============================================

# ä¸»åˆ†æ”¯æ¨é€ - åŒæ­¥åˆ° GitHub
main:
  push:
    - runner:
        tags: cnb:arch:amd64
        cpus: 1
      imports: https://cnb.cool/dmxapi/claude-code-my/-/blob/main/env.yml
      stages:
        - name: sync to github with rebase
          image: tencentcom/git-sync
          settings:
            target_url: https://github.com/YeSongYun/OpenCode-DMXAPI.git
            auth_type: https
            username: ${GIT_USERNAME}
            password: ${GIT_ACCESS_TOKEN}
            sync_mode: rebase

# Tag æ¨é€ - è‡ªåŠ¨å‘å¸ƒ Release
$:
  tag_push:
    - runner:
        tags: cnb:arch:amd64
        cpus: 1
      imports: https://cnb.cool/dmxapi/claude-code-my/-/blob/main/env.yml
      stages:
        # 0. å…ˆåŒæ­¥ Tag åˆ° GitHub
        - name: sync tag to github
          image: alpine/git
          script:
            - git remote add github https://${GIT_USERNAME}:${GIT_ACCESS_TOKEN}@github.com/YeSongYun/OpenCode-DMXAPI.git || true
            - git push github ${CNB_BRANCH} --force

        # 1. ç”Ÿæˆæ›´æ–°æ—¥å¿—ï¼ˆä½¿ç”¨ git-cliff æ”¯æŒ commit è‡ªåŠ¨åˆ†ç±»ï¼‰
        - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
          image: cnbcool/default-build-env
          script:
            - curl -sSL https://github.com/orhun/git-cliff/releases/download/v2.7.0/git-cliff-2.7.0-x86_64-unknown-linux-gnu.tar.gz | tar xz
            - git fetch --tags origin
            - ./git-cliff-2.7.0/git-cliff --config cliff.toml --latest --strip header
          exports:
            stdout: RELEASE_NOTES

        # 2. ç¼–è¯‘å„å¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
        - name: ç¼–è¯‘ Windows AMD64
          image: golang:latest
          script:
            - CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o opencode-dmxapi-${CNB_BRANCH}-windows-amd64.exe

        - name: ç¼–è¯‘ Linux AMD64
          image: golang:latest
          script:
            - CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o opencode-dmxapi-${CNB_BRANCH}-linux-amd64

        - name: ç¼–è¯‘ Linux ARM64
          image: golang:latest
          script:
            - CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o opencode-dmxapi-${CNB_BRANCH}-linux-arm64

        - name: ç¼–è¯‘ macOS AMD64
          image: golang:latest
          script:
            - CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o opencode-dmxapi-${CNB_BRANCH}-darwin-amd64

        - name: ç¼–è¯‘ macOS ARM64
          image: golang:latest
          script:
            - CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o opencode-dmxapi-${CNB_BRANCH}-darwin-arm64

        # 3. å…ˆåˆ›å»º Releaseï¼ˆå¿…é¡»åœ¨ä¸Šä¼ é™„ä»¶ä¹‹å‰ï¼‰
        - name: åˆ›å»º Release
          type: git:release
          options:
            title: OpenCode DMXAPI ${CNB_BRANCH}
            description: |
              ## OpenCode DMXAPI é…ç½®å·¥å…· ${CNB_BRANCH}

              ä¸€é”®é…ç½® OpenCode ä½¿ç”¨ DMXAPI æœåŠ¡çš„è·¨å¹³å°å·¥å…·ã€‚

              ---

              ${RELEASE_NOTES}

              ---

              ### ğŸ“¥ ä¸‹è½½

              | å¹³å° | æ¶æ„ | æ–‡ä»¶ |
              |------|------|------|
              | Windows | x64 | `opencode-dmxapi-${CNB_BRANCH}-windows-amd64.exe` |
              | Linux | x64 | `opencode-dmxapi-${CNB_BRANCH}-linux-amd64` |
              | Linux | ARM64 | `opencode-dmxapi-${CNB_BRANCH}-linux-arm64` |
              | macOS | Intel | `opencode-dmxapi-${CNB_BRANCH}-darwin-amd64` |
              | macOS | Apple Silicon | `opencode-dmxapi-${CNB_BRANCH}-darwin-arm64` |

              ---

              ### ğŸ› ï¸ å®‰è£…è¯´æ˜

              #### Windows
              ```powershell
              # ä¸‹è½½åç›´æ¥è¿è¡Œ
              .\opencode-dmxapi-${CNB_BRANCH}-windows-amd64.exe
